<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.thtf.office.mapper.TblVehicleSchedulingMapper">
    <select id="select" parameterType="com.thtf.office.vo.VehicleSchedulingParamVO" resultType="com.thtf.office.entity.TblVehicleScheduling">
        select * from tbl_vehicle_scheduling
        <where>
            delete_time is null
            <if test="id != null">
                and id = #{id}
            </if>
            <if test="null != keyword">
                <trim prefix="and (" suffix=")" prefixOverrides="or">
                    <if test="null != keyCarNumber">
                        or car_number like CONCAT('%',#{keyCarNumber},'%')
                    </if>
                    <if test="null != keyCarNumber">
                        or description like CONCAT('%',#{keyDescription},'%')
                    </if>
                </trim>
            </if>
            <if test="carNumber">
                and car_number = #{carNumber}
            </if>
            <if test="vehicleInfoId">
                vehicle_info_id = #{vehicleInfoId}
            </if>
            <if test="code != null">
                and code = #{code}
            </if>
            <if test="vehicleCategoryId">
                and vehicle_category_id = #{vehicleCategoryId}
            </if>
            <if test="userName">
                and user_name = #{userName}
            </if>
            <if test="organizationId">
                and organization_id = #{organizationId}
            </if>
            <if test="organizationName">
                and organization_name = #{organizationName}
            </if>
            <if test="purpose">
                and purpose = #{purpose}
            </if>
            <if test="driverId">
                and driver_id = #{driverId}
            </if>
            <if test="driverName">
                and driver_name = #{driverName}
            </if>
            <if test="startTime">
                and start_time = #{startTime}
            </if>
            <if test="endTime">
                and end_time = #{endTime}
            </if>
            order by create_time desc
        </where>
    </select>
    <!-- 按日、月查询空闲司机的每周月的出车情况 -->
    <select id="selectScheAboutDir" parameterType="java.util.Map" resultType="com.thtf.office.vo.VehicleSelectByDateResult">
        	select driver_id as id , driver_name as attribute,count(*) as ${numberType}
            from tbl_vehicle_scheduling as scheduling
            where scheduling.delete_time is null and DATE_FORMAT(end_time, #{dateTemplate}) = DATE_FORMAT(NOW(), #{dateTemplate})
            and driver_id not in (select distinct driver_id from tbl_vehicle_scheduling where start_time &lt; NOW() and now() &lt; end_time )
            group by driver_id
    </select>
    <select id="rankingsOfSchWD" parameterType="com.thtf.office.vo.VehicleStatisticsParamVO" resultType="com.thtf.office.vo.VehicleRankingsResultVO">
        select @rowno:=@rowno+1 as top,rate.car_number as attribute,rate.number as number
        from (
        select @rowno:=0, car_number ,sum(working_duration) as number,delete_time,start_time,end_time
        from tbl_vehicle_scheduling
        group by car_number
        having delete_time is null and #{startTime}  &lt;= start_time and end_time  &lt;= #{endTime}
        order by number desc
        ) as rate
    </select>
</mapper>
